<?php class clearSEO extends Controller { private $ssb_data;function __construct(){ global $registry;parent::__construct($registry);require_once DIR_CONFIG.'ssb_library/ssb_data.php';$this->ssb_data=ssb_data::getInstance();} static private $Instance =NULL;static public function getInstance() { if(self::$Instance==NULL){ $class=__CLASS__;self::$Instance=new $class;} return self::$Instance;} public function clear($entityData,$area='all'){ $time_start=microtime(true);$count=0;$param=array($entityData['category']['name'],$entityData['entity']['name']);$MD_EntityInDB=$this->ssb_data->getMatadata('EntitiesInDB',$param);foreach($MD_EntityInDB as $category=> $val){ $searchCondition=array();if(!isset($val['clear']) OR !is_array($val['clear']))continue;if($val['clear']['column']=='all'){ $sql="DELETE FROM ".DB_PREFIX.$val['table'];}else{ $sql="UPDATE ".DB_PREFIX.$val['table']." SET ";if(strpos($val['clear']['column'],',') !==false){ $columns=explode(',',$val['clear']['column']);foreach($columns as $column){ if(strpos($column,'=') !==false){ $sql.=$column.',';}else{ $searchCondition[]='`meta_seo_data` LIKE \'%' . $column . '":"'. $area .'%\'';$sql.=$column." = '',";} } $sql=substr($sql,0,-1).' ';}else{ $searchCondition[]='meta_seo_data LIKE \'%' . $val['clear']['column'] . '":"'. $area .'%\'';$sql.=$val['clear']['column']." = ''";} } $where=false;if($val['clear']['condition']){ if($area=='nag' AND ($entityData['entity']['name']=='CPBI_urls' || $entityData['category']['name']=='related_prod' || $entityData['category']['name']=='reviews' || $entityData['category']['name']=='descrip')){ $val['clear']['condition']=str_replace("=","<>",$val['clear']['condition']);$sql.="  WHERE ".$val['clear']['condition'];$where=true;if($entityData['entity']['name']=='CPBI_urls'){ $sql.=" AND auto_gen <> 'STAN_urls'";} }elseif($area !='all'){ $sql.="  WHERE ".$val['clear']['condition'];$where=true;}elseif($area=='all' AND $entityData['entity']['name']=='STAN_urls'){ $sql.="  WHERE ".$val['clear']['condition'];$where=true;} } if($entityData['entity']['name']=='CPBI_urls' AND $entityData['internal_entity']['name']){ $internal_entity=$entityData['internal_entity']['name'];if($internal_entity=='info'){ $internal_entity='information';}elseif($internal_entity=='brand'){ $internal_entity='manufacturer';} if($where){ $sql.=" AND query LIKE '" . $internal_entity . "_id=%'";}else{ $sql.=" WHERE query LIKE '" . $internal_entity . "_id=%'";$where=true;} } if(count($searchCondition) and $area !='all'){ if($area=='nag'){ $searchCondition='`meta_seo_data` = ""';$sql.=$where ? " AND ".$searchCondition:" WHERE ".$searchCondition;}else{ $searchCondition=implode(" AND ",$searchCondition);$sql.=$where ? " AND ".$searchCondition:" WHERE ".$searchCondition;} } $do_clear=$this->db->query($sql);$count+=$this->db->countAffected();} $time_end=microtime(true);$time=$time_end-$time_start;return array('total_time'=> $time,'total_count'=> $count);} } ?>
